<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner</title>
  <style>
    :root { --primary:#0066cc; }
    body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin:0; padding:0; background:#fff; color:#333;}
    main {padding:0.5rem; max-width:800px; margin:auto;}

    #cameraContainer {
      position:relative; width:300px; height:300px; margin:0.5rem auto;
      border:3px solid #ccc; border-radius:8px; overflow:hidden; background:#000;
    }
    #reader {width:100%; height:100%; display:block;}
    #reader video {width:100%; height:100%; object-fit:cover;}

    #overlayCanvas {
      position:absolute; top:0; left:0; width:100%; height:100%;
      pointer-events:none; opacity:0; transition:opacity .3s;
    }
    #overlayCanvas.visible {opacity:0.9;}

    .capture-btn {
      display:block; width:300px; margin:0.5rem auto;
      background:var(--primary); color:#fff; border:none; padding:0.8rem;
      font-size:1rem; border-radius:6px; cursor:pointer;
    }

    .status {text-align:center; padding:0.8rem; background:#f0f0f0; border-radius:6px; margin:0.5rem 0;}
    .btn {background:var(--primary); color:#fff; border:none; padding:0.7rem; border-radius:6px; font-size:0.95rem; width:100%; margin-top:0.4rem;}
    #result {margin:0.5rem 0; padding:0.8rem; background:#e9f7ef; border-radius:6px; text-align:center; font-weight:bold;}
    .form-row {display:flex; gap:0.4rem; margin:0.5rem 0; flex-wrap:wrap;}
    .form-row input {flex:1; min-width:100px; padding:0.5rem; font-size:0.95rem; border:1px solid #ccc; border-radius:4px;}
    .form-row button {background:var(--primary); color:#fff;}
    #exportBtn {margin-top:0.5rem; width:100%;}
    table {width:100%; border-collapse:collapse; margin-top:0.5rem; font-size:0.9rem;}
    th, td {border:1px solid #ddd; padding:0.4rem; text-align:left;}
    th {background:#f1f1f1;}
    .actions button {margin:0 0.1rem; font-size:0.75rem;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <main>
    <div id="cameraContainer" style="display:none;">
      <div id="reader"></div>
      <canvas id="overlayCanvas"></canvas>
    </div>
    <button id="captureBtn" class="capture-btn" style="display:none;">Capture</button>

    <div class="status" id="status">
      <p>Camera needed to scan barcodes.</p>
      <button id="startBtn" class="btn">Allow Camera</button>
    </div>

    <div id="result" style="display:none;"></div>

    <div class="form-row">
      <input type="text" id="barcodeInput" placeholder="Barcode" readonly>
      <input type="text" id="descInput" placeholder="Item">
      <input type="number" id="qtyInput" value="1" min="1">
      <button id="addBtn" class="btn">Add</button>
    </div>

    <button id="exportBtn" class="btn" style="display:none;">Export CSV</button>

    <table id="inventoryTable" style="display:none;">
      <thead><tr><th>Barcode</th><th>Item</th><th>Qty</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script>
    const db = new Dexie("InventoryDB");
    db.version(1).stores({ items: "++id,barcode,description,quantity" });

    const status = document.getElementById('status');
    const cameraContainer = document.getElementById('cameraContainer');
    const reader = document.getElementById('reader');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const ctx = overlayCanvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const result = document.getElementById('result');
    const barcodeInp = document.getElementById('barcodeInput');
    const descInp = document.getElementById('descInput');
    const qtyInp = document.getElementById('qtyInput');
    const addBtn = document.getElementById('addBtn');
    const table = document.getElementById('inventoryTable');
    const tbody = table.querySelector('tbody');
    const exportBtn = document.getElementById('exportBtn');

    let scannerActive = false, lastCode = null, currentVideo = null;

    startBtn.onclick = () => {
      status.innerHTML = "<p>Starting camera...</p>";
      Quagga.init({
        inputStream: {
          name: "Live", type: "LiveStream", target: reader,
          constraints: { facingMode: "environment", width: {ideal: 640}, height: {ideal: 640} }
        },
        decoder: {
          readers: ["ean_reader", "upc_reader", "code_128_reader"]
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        numOfWorkers: 2,
        frequency: 10,
        locate: true
      }, err => {
        if (err) { status.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`; return; }
        Quagga.start(); scannerActive = true;
        currentVideo = reader.querySelector('video');
        cameraContainer.style.display = 'block';
        captureBtn.style.display = 'block';
        status.style.display = 'none';
        const resize = () => { overlayCanvas.width = currentVideo.videoWidth; overlayCanvas.height = currentVideo.videoHeight; };
        currentVideo.addEventListener('loadedmetadata', resize);
      });
    };

    function isValidBarcode(code) {
      const clean = code.replace(/\D/g, '');
      return clean.length >= 8 && clean.length <= 13 && /^\d+$/.test(clean);
    }

    function drawOverlay(codeResult) {
      ctx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
      ctx.drawImage(currentVideo,0,0,overlayCanvas.width,overlayCanvas.height);
      if (codeResult.boxes) {
        ctx.strokeStyle = 'red'; ctx.lineWidth = 3;
        codeResult.boxes.forEach(b => {
          ctx.beginPath(); ctx.moveTo(b[0][0],b[0][1]);
          for (let i=1;i<b.length;i++) ctx.lineTo(b[i][0],b[i][1]);
          ctx.closePath(); ctx.stroke();
        });
      }
      const cleanCode = codeResult.code.replace(/\D/g, '');
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(0,overlayCanvas.height-36,overlayCanvas.width,36);
      ctx.font = 'bold 18px sans-serif'; ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.fillText(cleanCode, overlayCanvas.width/2, overlayCanvas.height-12);
      overlayCanvas.classList.add('visible');
    }
    function hideOverlay(){ overlayCanvas.classList.remove('visible'); }

    captureBtn.onclick = () => {
      Quagga.decodeSingle({
        decoder: { readers: ["ean_reader","upc_reader","code_128_reader"] },
        locator: { patchSize: "medium", halfSample: true },
        locate: true,
        src: currentVideo
      }, r => {
        if (r && r.codeResult && isValidBarcode(r.codeResult.code)) {
          handleCode(r.codeResult);
        } else {
          alert("No valid barcode. Try again.");
        }
      });
    };

    Quagga.onDetected(d => {
      const code = d.codeResult.code;
      if (!isValidBarcode(code)) return;
      const clean = code.replace(/\D/g, '');
      if (clean === lastCode) return;
      lastCode = clean;
      setTimeout(() => lastCode = null, 2000);
      handleCode(d.codeResult);
    });

    function handleCode(cr){
      const clean = cr.code.replace(/\D/g, '');
      barcodeInp.value = clean;
      result.textContent = `Scanned: ${clean}`;
      result.style.display = 'block';
      descInp.focus();
      drawOverlay(cr);
    }

    addBtn.onclick = async () => {
      const b = barcodeInp.value.trim(), d = descInp.value.trim()||"â€”", q = +qtyInp.value||1;
      if(!b) return alert("Scan first!");
      const ex = await db.items.where({barcode:b}).first();
      ex ? await db.items.update(ex.id,{quantity:ex.quantity+q})
         : await db.items.add({barcode:b,description:d,quantity:q});
      barcodeInp.value = descInp.value = ""; qtyInp.value = 1;
      result.style.display = 'none'; hideOverlay(); render();
    };

    async function render(){
      const items = await db.items.toArray();
      if(!items.length){ table.style.display='none'; exportBtn.style.display='none'; return; }
      tbody.innerHTML = "";
      items.forEach(i=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i.barcode}</td><td>${i.description}</td><td>${i.quantity}</td>
          <td class="actions">
            <button onclick="edit(${i.id},-1)">-1</button>
            <button onclick="edit(${i.id},1)">+1</button>
            <button onclick="del(${i.id})" style="color:red;">Del</button>
          </td>`;
        tbody.appendChild(tr);
      });
      table.style.display='table'; exportBtn.style.display='block';
    }

    window.edit = async (id,delta)=>{
      const rec = await db.items.get(id);
      const n = rec.quantity+delta;
      n<=0 ? confirm("Remove?")&&await db.items.delete(id) : await db.items.update(id,{quantity:n});
      render();
    };
    window.del = async id=>{ if(confirm("Delete?")){await db.items.delete(id);render();}};

    exportBtn.onclick = async () => {
      const items = await db.items.toArray();
      let csv = "Barcode,Item,Quantity\n";
      items.forEach(i=>csv+=`" ${i.barcode}","${i.description}",${i.quantity}\n`);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
      a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };

    render();
  </script>
</body>
</html>
