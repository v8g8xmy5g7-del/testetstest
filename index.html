<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner</title>
  <style>
    :root { --primary:#0066cc; --thumb:#28a745; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin:0; padding:0; background:#f8f9fa; color:#333;
      min-height:100vh; display:flex; flex-direction:column;
    }
    main {
      flex:1; padding:0.5rem; max-width:800px; margin:auto; width:100%;
      display:flex; flex-direction:column;
    }

    /* Wide Camera View */
    #cameraContainer {
      position:relative; width:100%; max-width:500px; height:300px;
      margin:0.5rem auto; border:3px solid #ccc; border-radius:12px;
      overflow:hidden; background:#000; align-self:center;
    }
    #reader {width:100%; height:100%; display:block;}
    #reader video {width:100%; height:100%; object-fit:cover;}

    #overlayCanvas {
      position:absolute; top:0; left:0; width:100%; height:100%;
      pointer-events:none; opacity:0; transition:opacity .3s;
    }
    #overlayCanvas.visible {opacity:0.9;}

    /* Status */
    .status {
      text-align:center; padding:0.8rem; background:#fff; border-radius:10px;
      margin:0.5rem 0; box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    .btn {
      background:var(--primary); color:#fff; border:none; padding:0.75rem;
      border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer;
    }

    /* Result */
    #result {
      margin:0.5rem 0; padding:0.8rem; background:#e9f7ef; border-radius:10px;
      text-align:center; font-weight:bold; font-size:1.1rem;
    }

    /* Form Row */
    .form-row {
      display:flex; gap:0.5rem; margin:0.5rem 0; flex-wrap:nowrap;
    }
    .form-row input {
      flex:1; min-width:0; padding:0.6rem; font-size:1rem;
      border:1px solid #ccc; border-radius:8px;
    }
    .form-row button {
      background:var(--primary); color:#fff; padding:0.6rem 1rem;
      border-radius:8px; font-weight:600;
    }

    /* Inventory Table */
    #inventoryTable {
      width:100%; border-collapse:collapse; margin:0.5rem 0;
      font-size:0.95rem; background:#fff; border-radius:10px; overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {border-bottom:1px solid #eee; padding:0.6rem; text-align:left;}
    th {background:#f1f1f1; font-weight:600;}
    .actions button {
      margin:0 0.2rem; font-size:0.8rem; padding:0.3rem 0.5rem;
      border-radius:6px; border:none; cursor:pointer;
    }
    .actions button:nth-child(1) {background:#ffc107; color:#000;}
    .actions button:nth-child(2) {background:#28a745; color:#fff;}
    .actions button:nth-child(3) {background:#dc3545; color:#fff;}

    /* Export Button */
    #exportBtn {
      margin:0.5rem 0; width:100%; background:#17a2b8; color:#fff;
      padding:0.9rem; border-radius:12px; font-size:1.1rem; font-weight:600;
    }

    /* Fixed Bottom Capture Button */
    #captureBtn {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      width:90%; max-width:500px; background:var(--thumb); color:#fff;
      padding:1rem; font-size:1.3rem; font-weight:700; border:none;
      border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:1000; cursor:pointer;
    }

    /* Safe Area for iPhone Notch */
    @supports (padding:max(0px)) {
      main { padding-bottom: env(safe-area-inset-bottom, 20px); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <main>
    <!-- Camera -->
    <div id="cameraContainer" style="display:none;">
      <div id="reader"></div>
      <canvas id="overlayCanvas"></canvas>
    </div>

    <!-- Status -->
    <div class="status" id="status">
      <p>Camera needed to scan barcodes.</p>
      <button id="startBtn" class="btn">Allow Camera</button>
    </div>

    <!-- Result -->
    <div id="result" style="display:none;"></div>

    <!-- Inventory Table (above form) -->
    <table id="inventoryTable" style="display:none;">
      <thead><tr><th>Barcode</th><th>Item</th><th>Qty</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Form -->
    <div class="form-row">
      <input type="text" id="barcodeInput" placeholder="Barcode" readonly>
      <input type="text" id="descInput" placeholder="Item">
      <input type="number" id="qtyInput" value="1" min="1">
      <button id="addBtn" class="btn">Add</button>
    </div>

    <!-- Export -->
    <button id="exportBtn" class="btn" style="display:none;">Export CSV</button>
  </main>

  <!-- Fixed Bottom Capture Button -->
  <button id="captureBtn" style="display:none;">Capture</button>

  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script>
    const db = new Dexie("InventoryDB");
    db.version(1).stores({ items: "++id,barcode,description,quantity" });

    const status = document.getElementById('status');
    const cameraContainer = document.getElementById('cameraContainer');
    const reader = document.getElementById('reader');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const ctx = overlayCanvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const result = document.getElementById('result');
    const barcodeInp = document.getElementById('barcodeInput');
    const descInp = document.getElementById('descInput');
    const qtyInp = document.getElementById('qtyInput');
    const addBtn = document.getElementById('addBtn');
    const table = document.getElementById('inventoryTable');
    const tbody = table.querySelector('tbody');
    const exportBtn = document.getElementById('exportBtn');

    let scannerActive = false, lastCode = null, currentVideo = null;

    startBtn.onclick = () => {
      status.innerHTML = "<p>Starting camera...</p>";
      Quagga.init({
        inputStream: {
          name: "Live", type: "LiveStream", target: reader,
          constraints: { facingMode: "environment", width: {ideal: 800}, height: {ideal: 480} }
        },
        decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] },
        locator: { patchSize: "medium", halfSample: true },
        numOfWorkers: 2, frequency: 10, locate: true
      }, err => {
        if (err) { status.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`; return; }
        Quagga.start(); scannerActive = true;
        currentVideo = reader.querySelector('video');
        cameraContainer.style.display = 'block';
        captureBtn.style.display = 'block';
        status.style.display = 'none';
        const resize = () => { overlayCanvas.width = currentVideo.videoWidth; overlayCanvas.height = currentVideo.videoHeight; };
        currentVideo.addEventListener('loadedmetadata', resize);
      });
    };

    function isValidBarcode(code) {
      const clean = code.replace(/\D/g, '');
      return clean.length >= 8 && clean.length <= 13 && /^\d+$/.test(clean);
    }

    function drawOverlay(codeResult) {
      ctx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
      ctx.drawImage(currentVideo,0,0,overlayCanvas.width,overlayCanvas.height);
      if (codeResult.boxes) {
        ctx.strokeStyle = 'red'; ctx.lineWidth = 4;
        codeResult.boxes.forEach(b => {
          ctx.beginPath(); ctx.moveTo(b[0][0],b[0][1]);
          for (let i=1;i<b.length;i++) ctx.lineTo(b[i][0],b[i][1]);
          ctx.closePath(); ctx.stroke();
        });
      }
      const cleanCode = codeResult.code.replace(/\D/g, '');
      ctx.fillStyle = 'rgba(0,0,0,0.8)';
      ctx.fillRect(0,overlayCanvas.height-40,overlayCanvas.width,40);
      ctx.font = 'bold 20px sans-serif'; ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.fillText(cleanCode, overlayCanvas.width/2, overlayCanvas.height-12);
      overlayCanvas.classList.add('visible');
    }
    function hideOverlay(){ overlayCanvas.classList.remove('visible'); }

    captureBtn.onclick = () => {
      Quagga.decodeSingle({
        decoder: { readers: ["ean_reader","upc_reader","code_128_reader"] },
        locator: { patchSize: "medium", halfSample: true },
        locate: true, src: currentVideo
      }, r => {
        if (r && r.codeResult && isValidBarcode(r.codeResult.code)) {
          handleCode(r.codeResult);
        } else {
          alert("No valid barcode. Try again.");
        }
      });
    };

    Quagga.onDetected(d => {
      const code = d.codeResult.code;
      if (!isValidBarcode(code)) return;
      const clean = code.replace(/\D/g, '');
      if (clean === lastCode) return;
      lastCode = clean;
      setTimeout(() => lastCode = null, 2000);
      handleCode(d.codeResult);
    });

    function handleCode(cr){
      const clean = cr.code.replace(/\D/g, '');
      barcodeInp.value = clean;
      result.textContent = `Scanned: ${clean}`;
      result.style.display = 'block';
      descInp.focus();
      drawOverlay(cr);
    }

    addBtn.onclick = async () => {
      const b = barcodeInp.value.trim(), d = descInp.value.trim()||"â€”", q = +qtyInp.value||1;
      if(!b) return alert("Scan first!");
      const ex = await db.items.where({barcode:b}).first();
      ex ? await db.items.update(ex.id,{quantity:ex.quantity+q})
         : await db.items.add({barcode:b,description:d,quantity:q});
      barcodeInp.value = descInp.value = ""; qtyInp.value = 1;
      result.style.display = 'none'; hideOverlay(); render();
    };

    async function render(){
      const items = await db.items.toArray();
      if(!items.length){ table.style.display='none'; exportBtn.style.display='none'; return; }
      tbody.innerHTML = "";
      items.forEach(i=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i.barcode}</td><td>${i.description}</td><td>${i.quantity}</td>
          <td class="actions">
            <button onclick="edit(${i.id},-1)">-1</button>
            <button onclick="edit(${i.id},1)">+1</button>
            <button onclick="del(${i.id})">Del</button>
          </td>`;
        tbody.appendChild(tr);
      });
      table.style.display='table'; exportBtn.style.display='block';
    }

    window.edit = async (id,delta)=>{
      const rec = await db.items.get(id);
      const n = rec.quantity+delta;
      n<=0 ? confirm("Remove?")&&await db.items.delete(id) : await db.items.update(id,{quantity:n});
      render();
    };
    window.del = async id=>{ if(confirm("Delete?")){await db.items.delete(id);render();}};

    exportBtn.onclick = async () => {
      const items = await db.items.toArray();
      let csv = "Barcode,Item,Quantity\n";
      items.forEach(i=>csv+=`" ${i.barcode}","${i.description}",${i.quantity}\n`);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
      a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };

    render();
  </script>
</body>
</html>
