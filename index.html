<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Scanner</title>
  <style>
    :root { --primary:#0066cc; }
    body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin:0; padding:0; background:#fff; color:#333;}
    header {background:var(--primary); color:#fff; padding:1rem; text-align:center;}
    main {padding:1rem; max-width:800px; margin:auto;}
    #reader {
      width:100%; max-width:340px; height:auto; aspect-ratio:4/3;
      margin:1rem auto; display:block; border:3px solid #ccc;
      border-radius:8px; background:#000; overflow:hidden;
    }
    #reader video {width:100%; height:100%; object-fit:cover;}
    .capture-btn {
      display:block; width:100%; max-width:340px; margin:0.5rem auto;
      background:var(--primary); color:#fff; border:none; padding:0.9rem;
      font-size:1.1rem; border-radius:6px; cursor:pointer;
    }
    #snapshot {
      width:100%; max-width:340px; margin:0.5rem auto; display:none;
      border:2px solid #28a745; border-radius:6px; image-rendering:pixelated;
    }
    .status {text-align:center; padding:1rem; background:#f0f0f0; border-radius:8px; margin:1rem 0;}
    .btn {background:var(--primary); color:#fff; border:none; padding:0.8rem; border-radius:6px; font-size:1rem; width:100%; margin-top:0.5rem;}
    #result {margin:1rem 0; padding:1rem; background:#e9f7ef; border-radius:6px; text-align:center; font-weight:bold;}
    .form-row {display:flex; gap:0.5rem; margin:1rem 0; flex-wrap:wrap;}
    .form-row input {flex:1; min-width:120px; padding:0.6rem; font-size:1rem; border:1px solid #ccc; border-radius:4px;}
    .form-row button {background:var(--primary); color:#fff;}
    #exportBtn {margin-top:1rem; width:100%;}
    table {width:100%; border-collapse:collapse; margin-top:1rem;}
    th, td {border:1px solid #ddd; padding:0.6rem; text-align:left;}
    th {background:#f1f1f1;}
    .actions button {margin:0 0.2rem; font-size:0.8rem;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <header><h1>Inventory Scanner</h1></header>
  <main>
    <div id="reader" style="display:none;"></div>
    <canvas id="snapshotCanvas" style="display:none;"></canvas>
    <img id="snapshot" alt="Scanned barcode" style="display:none;">

    <button id="captureBtn" class="capture-btn" style="display:none;">Capture</button>

    <div class="status" id="status">
      <p>Camera access is required to scan barcodes.</p>
      <button id="startBtn" class="btn">Allow Camera & Start</button>
    </div>

    <div id="result" style="display:none;"></div>

    <div class="form-row">
      <input type="text" id="barcodeInput" placeholder="Barcode" readonly>
      <input type="text" id="descInput" placeholder="Item name">
      <input type="number" id="qtyInput" value="1" min="1">
      <button id="addBtn" class="btn">Add</button>
    </div>

    <button id="exportBtn" class="btn" style="display:none;">Export CSV</button>

    <table id="inventoryTable" style="display:none;">
      <thead><tr><th>Barcode</th><th>Item</th><th>Qty</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script>
    const db = new Dexie("InventoryDB");
    db.version(1).stores({ items: "++id,barcode,description,quantity" });

    const status       = document.getElementById('status');
    const reader       = document.getElementById('reader');
    const video        = null; // will be set after start
    const canvas       = document.getElementById('snapshotCanvas');
    const snapshotImg  = document.getElementById('snapshot');
    const startBtn     = document.getElementById('startBtn');
    const captureBtn   = document.getElementById('captureBtn');
    const result       = document.getElementById('result');
    const barcodeInp   = document.getElementById('barcodeInput');
    const descInp      = document.getElementById('descInput');
    const qtyInp       = document.getElementById('qtyInput');
    const addBtn       = document.getElementById('addBtn');
    const table        = document.getElementById('inventoryTable');
    const tbody        = table.querySelector('tbody');
    const exportBtn    = document.getElementById('exportBtn');

    let scannerActive = false;
    let lastCode = null;
    let currentVideo = null;

    // ---- Start Camera ----
    startBtn.onclick = () => {
      status.innerHTML = "<p>Requesting camera...</p>";
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: reader,
          constraints: { facingMode: "environment", width: {ideal: 640}, height: {ideal: 480} }
        },
        decoder: { readers: ["ean_reader","upc_reader","code_128_reader"] },
        locate: true
      }, err => {
        if (err) {
          status.innerHTML = `<p style="color:red;">Camera error: ${err.message}</p><p>Use HTTPS.</p>`;
          console.error(err);
          return;
        }
        Quagga.start();
        scannerActive = true;
        currentVideo = reader.querySelector('video');
        reader.style.display = 'block';
        captureBtn.style.display = 'block';
        status.style.display = 'none';
      });
    };

    // ---- Take Snapshot & Draw Box ----
    function takeSnapshot(codeResult) {
      if (!currentVideo) return;
      const ctx = canvas.getContext('2d');
      canvas.width = currentVideo.videoWidth;
      canvas.height = currentVideo.videoHeight;
      ctx.drawImage(currentVideo, 0, 0);

      // Draw red box around barcode
      if (codeResult && codeResult.boxes) {
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 3;
        codeResult.boxes.forEach(box => {
          ctx.beginPath();
          ctx.moveTo(box[0][0], box[0][1]);
          for (let i = 1; i < box.length; i++) {
            ctx.lineTo(box[i][0], box[i][1]);
          }
          ctx.closePath();
          ctx.stroke();
        });
      }

      // Show image
      snapshotImg.src = canvas.toDataURL('image/png');
      snapshotImg.style.display = 'block';
      canvas.style.display = 'none';
    }

    // ---- Manual Capture ----
    captureBtn.onclick = () => {
      if (!currentVideo) return;
      Quagga.decodeSingle({
        decoder: { readers: ["ean_reader","upc_reader","code_128_reader"] },
        locate: true,
        src: currentVideo
      }, result => {
        if (result && result.codeResult) {
          handleCode(result.codeResult);
        } else {
          alert("No barcode found. Try moving closer or tapping again.");
        }
      });
    };

    // ---- Auto Detect + Snapshot ----
    Quagga.onDetected(data => {
      const code = data.codeResult.code;
      if (code === lastCode) return;
      lastCode = code;
      setTimeout(() => lastCode = null, 2500);

      handleCode(data.codeResult);
    });

    function handleCode(codeResult) {
      const code = codeResult.code;
      barcodeInp.value = code;
      result.textContent = `Scanned: ${code}`;
      result.style.display = 'block';
      descInp.focus();

      // TAKE SNAPSHOT
      takeSnapshot(codeResult);
    }

    // ---- Add Item ----
    addBtn.onclick = async () => {
      const barcode = barcodeInp.value.trim();
      const desc = descInp.value.trim() || "â€”";
      const qty = parseInt(qtyInp.value) || 1;
      if (!barcode) return alert("Scan first!");

      const existing = await db.items.where({barcode}).first();
      if (existing) {
        await db.items.update(existing.id, {quantity: existing.quantity + qty});
      } else {
        await db.items.add({barcode, description: desc, quantity: qty});
      }
      barcodeInp.value = descInp.value = ""; qtyInp.value = 1;
      result.style.display = 'none';
      snapshotImg.style.display = 'none'; // hide old photo
      render();
    };

    // ---- Render Table ----
    async function render() {
      const items = await db.items.toArray();
      if (items.length === 0) {
        table.style.display = 'none';
        exportBtn.style.display = 'none';
        return;
      }
      tbody.innerHTML = "";
      items.forEach(i => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i.barcode}</td><td>${i.description}</td><td>${i.quantity}</td>
          <td class="actions">
            <button onclick="edit(${i.id},-1)">-1</button>
            <button onclick="edit(${i.id},1)">+1</button>
            <button onclick="del(${i.id})" style="color:red;">Del</button>
          </td>`;
        tbody.appendChild(tr);
      });
      table.style.display = 'table';
      exportBtn.style.display = 'block';
    }

    window.edit = async (id, d) => {
      const rec = await db.items.get(id);
      const newQty = rec.quantity + d;
      if (newQty <= 0) { if (confirm("Remove?")) await db.items.delete(id); }
      else await db.items.update(id, {quantity: newQty});
      render();
    };
    window.del = async (id) => {
      if (confirm("Delete?")) { await db.items.delete(id); render(); }
    };

    // ---- Export CSV ----
    exportBtn.onclick = async () => {
      const items = await db.items.toArray();
      let csv = "Barcode,Item,Quantity\n";
      items.forEach(i => csv += `"${i.barcode}","${i.description}",${i.quantity}\n`);
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    };

    render();
  </script>
</body>
</html>
